name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ============================================================================
  # Unit Tests - Test core ezmon functionality across Python versions and OSes
  # ============================================================================
  unit-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          pytest tests/ -v --tb=short

      - name: Run tests with coverage
        if: matrix.python-version == '3.10' && matrix.os == 'ubuntu-latest'
        run: |
          pytest tests/ -v --cov=ezmon --cov-report=xml

      - name: Upload coverage
        if: matrix.python-version == '3.10' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # ============================================================================
  # Pytest Version Compatibility - Test against different pytest versions
  # ============================================================================
  pytest-versions:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pytest-version: ['6.2.5', '7.4.4', '8.3.5']
        python-version: ['3.10']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest==${{ matrix.pytest-version }} pytest-cov

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short

  # ============================================================================
  # Integration Tests (Local DB) - Test sample project with local .testmondata
  # ============================================================================
  integration-local-db:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.10', '3.11']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install ezmon
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run integration tests (local DB mode)
        run: |
          python integration_tests/run_integration_tests.py -v

  # ============================================================================
  # Integration Tests (NetDB) - Test sample project with Flask server
  # ============================================================================
  integration-netdb:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install ezmon and server dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install flask flask-cors python-dotenv

      - name: Start Flask server in background
        run: |
          cd ez-viz
          # Create minimal .env for testing
          echo "SECRET_KEY=test-secret-key-for-ci" > .env
          echo "TESTMON_DATA_DIR=${{ github.workspace }}/testmon-data" >> .env
          mkdir -p ${{ github.workspace }}/testmon-data

          # Start server in background
          python app.py &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV

          # Wait for server to be ready
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8004/health > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Server failed to start"
              exit 1
            fi
            sleep 1
          done

      - name: Test RPC endpoints
        run: |
          cd ez-viz
          python test_rpc_endpoints.py --url http://localhost:8004

      - name: Test NetDB client
        run: |
          cd ez-viz
          python test_net_db.py --url http://localhost:8004

      - name: Run sample project with NetDB mode
        env:
          TESTMON_NET_ENABLED: "true"
          TESTMON_SERVER: "http://localhost:8004"
          REPO_ID: "test/sample-project"
          JOB_ID: "ci-netdb-test"
          TESTMON_AUTH_TOKEN: "test-token"
        run: |
          cd integration_tests/sample_project

          # Initialize git (required by ezmon)
          git init
          git config user.email "ci@test.com"
          git config user.name "CI Test"
          git add -A
          git commit -m "Initial commit"

          # First run - build database
          echo "=== First run (building database) ==="
          pytest --ezmon -v 2>&1 | tee first_run.log

          # Second run - should use cached data
          echo "=== Second run (using cache) ==="
          pytest --ezmon -v 2>&1 | tee second_run.log

          # Verify some tests were deselected (indicating ezmon is working)
          if grep -q "deselected" second_run.log; then
            echo "✓ Tests were properly deselected on second run"
          else
            echo "Note: No tests deselected (may be expected if all tests affected)"
          fi

      - name: Verify data stored on server
        run: |
          # Check that test data was stored
          curl -s -X GET "http://localhost:8004/api/rpc/tests/all?exec_id=1" \
            -H "Authorization: Bearer test-token" \
            -H "X-Repo-ID: test/sample-project" \
            -H "X-Job-ID: ci-netdb-test" | python -c "
          import sys, json
          data = json.load(sys.stdin)
          tests = data.get('tests', {})
          print(f'Found {len(tests)} tests stored on server')
          if len(tests) > 0:
              print('✓ Test data successfully stored via NetDB')
              sys.exit(0)
          else:
              print('✗ No test data found on server')
              sys.exit(1)
          "

      - name: Stop Flask server
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            kill $SERVER_PID 2>/dev/null || true
          fi
          # Also kill any remaining python processes running app.py
          pkill -f "python app.py" || true

  # ============================================================================
  # Lint - Code quality checks
  # ============================================================================
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install lint dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8

      - name: Check formatting with black
        run: black --check ezmon/ tests/ || true

      - name: Lint with flake8
        run: flake8 ezmon/ tests/ --max-line-length=120 --ignore=E501,W503 || true
