name: Test

on:
  # Run after deploy workflow completes (for push to main)
  workflow_run:
    workflows: ["Deploy Testmon Server"]
    types: [completed]
    branches: [main]
  # Run directly for PRs (no deploy needed)
  pull_request:
    branches: [main]
  # Manual trigger
  workflow_dispatch:

env:
  # NetDB configuration - uses the production server
  TESTMON_NET_ENABLED: "true"
  TESTMON_SERVER: "https://ezmon.aloiz.ch"
  TESTMON_AUTH_TOKEN: "ezmon-ci-test-token-2024"

jobs:
  # ============================================================================
  # Unit Tests - Self-hosted macOS runner with NetDB
  # ============================================================================
  unit-tests:
    runs-on: self-hosted
    # Skip if triggered by workflow_run and deploy failed
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    env:
      REPO_ID: ${{ github.repository }}
      JOB_ID: "unit-tests"
      RUN_ID: ${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -e .
          pip3 install pytest pytest-cov

      - name: Run unit tests with ezmon
        run: python3 -m pytest tests/ -v --ezmon --tb=short

  # ============================================================================
  # Integration Tests - Self-hosted macOS runner with NetDB
  # ============================================================================
  integration-tests:
    runs-on: self-hosted
    # Skip if triggered by workflow_run and deploy failed
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    env:
      REPO_ID: ${{ github.repository }}
      JOB_ID: "integration-tests"
      RUN_ID: ${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Install ezmon
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -e .

      - name: Run integration tests with ezmon
        run: python3 integration_tests/run_integration_tests.py -v

  # ============================================================================
  # Lint
  # ============================================================================
  lint:
    runs-on: self-hosted
    # Skip if triggered by workflow_run and deploy failed
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Lint
        run: |
          pip3 install flake8
          flake8 ezmon/ --max-line-length=120 --ignore=E501,W503 || true
