name: Deploy Testmon Server

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  APP_REPO_PATH: /Users/andreasloizides/pytest-testmon/ez-viz          # â¬…ï¸ change if needed
  DEPLOY_STATE_DIR: /Users/andreasloizides/pytest-testmon/ez-viz.deploy-state
  PM2_NAME: testmon-server                                           # â¬…ï¸ matches your PM2 app name
  VENV_DIR: /Users/andreasloizides/pytest-testmon/ez-viz/.venv          # â¬…ï¸ your venv path
  HEALTH_URL: http://127.0.0.1:8004/health

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        working-directory: ${{ env.APP_REPO_PATH }}

    steps:
      - name: Update repository
        run: |
          echo "ðŸ”„ Updating repository..."
          git fetch origin
          git reset --hard origin/main
          git clean -fd

      - name: Ensure deploy state dir
        run: mkdir -p "${{ env.DEPLOY_STATE_DIR }}"

      - name: Detect changes since last success
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          CURRENT_COMMIT=$(git rev-parse HEAD)
          LAST_SUCCESS_FILE="${{ env.DEPLOY_STATE_DIR }}/deploy-success"
          LAST_SUCCESS=""
          if [[ -f "$LAST_SUCCESS_FILE" ]]; then
            LAST_SUCCESS=$(cat "$LAST_SUCCESS_FILE" || true)
          fi

          # First deploy - everything needs to run
          if [[ -z "$LAST_SUCCESS" ]]; then
            echo "No previous successful deploy; treating as first deploy."
            echo "backend=true" >> "$GITHUB_OUTPUT"
            echo "frontend=true" >> "$GITHUB_OUTPUT"
            echo "deps=true" >> "$GITHUB_OUTPUT"
            echo "any_changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Get all changed files
          ALL_CHANGES=$(git diff --name-only "$LAST_SUCCESS" "$CURRENT_COMMIT" || true)

          if [[ -z "$ALL_CHANGES" ]]; then
            echo "ðŸ“Š No changes since last successful deployment"
            echo "backend=false" >> "$GITHUB_OUTPUT"
            echo "frontend=false" >> "$GITHUB_OUTPUT"
            echo "deps=false" >> "$GITHUB_OUTPUT"
            echo "any_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed files since last deploy:"
          echo "$ALL_CHANGES" | sed 's/^/  - /'

          # Backend changes (Python code) - requires PM2 restart
          BACKEND_CHANGES=$(echo "$ALL_CHANGES" | \
            grep -E '\.(py)$|^ecosystem\.config\.(cjs|js)$|^templates/|^static/' || true)
          if [[ -n "$BACKEND_CHANGES" ]]; then
            echo "backend=true" >> "$GITHUB_OUTPUT"
            echo "ðŸ Backend changes detected"
          else
            echo "backend=false" >> "$GITHUB_OUTPUT"
          fi

          # Frontend changes (React build) - served directly, no restart needed
          FRONTEND_CHANGES=$(echo "$ALL_CHANGES" | grep -E 'client/dist/' || true)
          if [[ -n "$FRONTEND_CHANGES" ]]; then
            echo "frontend=true" >> "$GITHUB_OUTPUT"
            echo "âš›ï¸  Frontend changes detected"
          else
            echo "frontend=false" >> "$GITHUB_OUTPUT"
          fi

          # Dependency changes
          if echo "$ALL_CHANGES" | grep -q 'requirements\.txt$'; then
            echo "deps=true" >> "$GITHUB_OUTPUT"
            echo "ðŸ“¦ Dependencies changed"
          else
            echo "deps=false" >> "$GITHUB_OUTPUT"
          fi

          # Any deployment-relevant changes?
          if [[ -n "$BACKEND_CHANGES" ]] || [[ -n "$FRONTEND_CHANGES" ]]; then
            echo "any_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "any_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare venv & deps (if backend changed)
        if: steps.changes.outputs.backend == 'true'
        shell: bash
        run: |
          set -euo pipefail
          # create venv if missing
          if [[ ! -d "${{ env.VENV_DIR }}" ]]; then
            echo "ðŸ Creating venv at ${{ env.VENV_DIR }}"
            python3 -m venv "${{ env.VENV_DIR }}"
          fi
          source "${{ env.VENV_DIR }}/bin/activate"
          python -m pip install --upgrade pip >/dev/null

          if [[ "${{ steps.changes.outputs.deps }}" == "true" ]]; then
            echo "ðŸ“¦ requirements.txt changed (or first deploy) â€” installingâ€¦"
            pip install -r requirements.txt --quiet
          else
            echo "ðŸ“¦ requirements.txt unchanged â€” skipping pip install"
          fi

      - name: PM2 start or graceful reload (if backend changed)
        if: steps.changes.outputs.backend == 'true'
        shell: bash
        run: |
          set -euo pipefail
          PM2_BIN=$(command -v pm2)
          if [[ -z "$PM2_BIN" ]]; then
            echo "pm2 not found in PATH"; exit 1
          fi

          # If process exists -> reload; else start from ecosystem file
          if pm2 describe "${{ env.PM2_NAME }}" >/dev/null 2>&1; then
            echo "ðŸ”„ Reloading ${{ env.PM2_NAME }} ..."
            pm2 reload "${{ env.PM2_NAME }}" --update-env
          else
            echo "â–¶ï¸ Starting ${{ env.PM2_NAME }} from ecosystem file..."
            # You can keep your ecosystem at repo root
            pm2 start /Users/andreasloizides/ecosystem.config.js --only "${{ env.PM2_NAME }}"
          fi

          pm2 save

      - name: Log frontend-only deploy
        if: steps.changes.outputs.frontend == 'true' && steps.changes.outputs.backend == 'false'
        run: |
          echo "âš›ï¸  Frontend-only changes - files deployed via git pull"
          echo "   No PM2 restart needed (Flask serves static files directly)"

      - name: Health check
        if: steps.changes.outputs.any_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail
          MAX_WAIT=60
          SLEEP=2
          ELAPSED=0
          echo "ðŸ” Checking ${{ env.HEALTH_URL }}"
          while true; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 2 "${{ env.HEALTH_URL }}" || echo "000")
            if [[ "$CODE" == "200" ]]; then
              echo "âœ… Healthy"
              break
            fi
            if (( ELAPSED >= MAX_WAIT )); then
              echo "âŒ Health check failed after ${MAX_WAIT}s (last HTTP ${CODE})"
              pm2 status "${{ env.PM2_NAME }}" || true
              pm2 logs   "${{ env.PM2_NAME }}" --lines 80 --nostream || true
              exit 1
            fi
            sleep "$SLEEP"
            ELAPSED=$((ELAPSED+SLEEP))
          done

      - name: Mark deployment success
        if: steps.changes.outputs.any_changes == 'true' && success()
        run: |
          git rev-parse HEAD > "${{ env.DEPLOY_STATE_DIR }}/deploy-success"
          echo "âœ… Deployment marker updated"
